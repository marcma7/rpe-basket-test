<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panell ADMIN</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: sans-serif; padding: 20px; background: #f5f7fa; }
h1 { text-align: center; }
#equip-selector { margin-bottom: 20px; font-size: 1.1rem; }
.container { display: flex; gap: 20px; }
.left, .right { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 5px 10px rgba(0,0,0,0.05); }
.left { flex: 1; }
.right { flex: 2; max-height: 600px; overflow-y: auto; }
label { display: block; margin-top: 10px; }
input[type=text], input[type=number] { width: 90%; padding: 5px; margin-top: 2px; }
input[type=checkbox] { transform: scale(1.2); margin-left: 5px; }
.jugador { display: flex; align-items: center; justify-content: space-between; padding: 8px; margin: 5px 0; background: #f1f1f1; border-radius: 6px; }
.jugador span { flex: 1; }
.jugador input { width: 60px; margin-left: 5px; }
.jugador input[type=checkbox] { width: auto; margin-left: 5px; }
#msg { margin-top: 10px; font-weight: bold; color: green; }
button { margin-top: 10px; padding: 5px 10px; }
</style>
</head>
<body>

<h1>Panell ADMIN</h1>
<p>Selecciona equip:</p>
<select id="equip-selector"></select>

<div class="container">
  <div class="left">
  <label>Data:
    <input type="date" id="data-activitat">
  </label>
  <label>Preparació Física:
    <input type="number" id="pf-text">
  </label>
  <label>Pista:
    <input type="number" id="pista-text">
  </label>
  <label>
    Partit:
    <input type="checkbox" id="partit-check">
  </label>
  <button id="aplicar-a-tots">Aplicar a tots</button>
</div>

<div class="right">
  <h3>Jugadors de l’equip</h3>
  <div id="jugadors-list"></div>
  <button id="guardar-tots">Guardar a la BBDD</button>
</div>
</div>
<h3>Calendari de sessions</h3>
<div style="display:flex; justify-content:space-between; align-items:center;">
  <button id="prev-mes">◀</button>
  <h3 id="titol-mes"></h3>
  <button id="next-mes">▶</button>
</div>

<div id="calendari" style="overflow-x:auto; margin-top:20px;">
  <table id="cal-table" border="1" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr id="cal-header"></tr>
    </thead>
    <tbody id="cal-body"></tbody>
  </table>
</div>





<p id="msg"></p>

<script>
const SUPABASE_URL = 'https://yixicmvonuiqdgcaiogb.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpeGljbXZvbnVpcWRnY2Fpb2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTU5MDksImV4cCI6MjA4NTU5MTkwOX0.NYiQN75-BqfiVkNRkwRsU6PE0fFleuPG6o5BaklhWgs'
  
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

const jugadorId = localStorage.getItem('jugadorId')
if (!jugadorId) { alert("No logat!"); window.location.href="rpe.html" }

const equipSelector = document.getElementById('equip-selector')
const dataInput = document.getElementById('data-activitat')
const pfInput = document.getElementById('pf-text')
const pistaInput = document.getElementById('pista-text')
const partitCheck = document.getElementById('partit-check')
const guardarBtn = document.getElementById('guardar-activitat')
const jugadorsList = document.getElementById('jugadors-list')
const msg = document.getElementById('msg')

let equipActual = null
let dataActual = null
let jugadors = []
let mesActual = new Date().getMonth()
let anyActual = new Date().getFullYear()
let dataSeleccionada = null
let dataArrossegada = null



async function init() {
  // 1️⃣ Saber perfil
  const { data: jugador } = await supabaseClient.from('users').select('rol').eq('id', jugadorId).single()
  let equips = []

  if (jugador.rol === 'SUPERADMIN') {
  const { data } = await supabaseClient
    .from('teams')
    .select('*')
    .order('nom')
  equips = data
} else if (jugador.rol === 'ADMIN') {
  const { data, error } = await supabaseClient
    .from('users_teams')
    .select('team_id, teams(nom)')
    .eq('user_id', jugadorId)

  if (error) {
    console.error(error)
    alert("Error carregant equips")
    return
  }

  equips = (data || [])
    .map(e => ({ id: e.team_id, nom: e.teams.nom }))
    .sort((a,b) => a.nom.localeCompare(b.nom))  // ordenar en JS

  if (equips.length === 0) {
    alert("No tens cap equip assignat")
    return
  }
}

 else { alert("No tens accés"); window.location.href="rpe.html" }

  // Omplir selector equips
  equipSelector.innerHTML = ''
  equips.forEach(e => { const opt=document.createElement('option'); opt.value=e.id; opt.textContent=e.nom; equipSelector.appendChild(opt) })
  equipActual = equips[0]?.id
  dataInput.value = new Date().toISOString().slice(0,10)

  if (equipActual) carregarJugadors(equipActual)
}

equipSelector.addEventListener('change', e => { equipActual=e.target.value; carregarJugadors(equipActual) })

// ----------------
// Carregar jugadors i dades del dia
// ----------------
async function carregarJugadors(equipId) {
  if (!equipId) return

  const avui = dataInput.value

  // 1️⃣ Agafem els jugadors del team via users_teams
  const { data: jugData, error: jugError } = await supabaseClient
    .from('users_teams')
    .select(`
      id,
      user_id,
      users (
        id,
        nom,
        cognom
      )
    `)
    .eq('team_id', equipId)
    .order('users(nom)')

  if (jugError) {
    console.error(jugError)
    return
  }

  // Convertim al format pla
  jugadors = jugData.map(j => ({
  id: j.users.id,
  nom: j.users.nom,
  cognom: j.users.cognom,
  user_team_id: j.id // o j.id si Supabase et retorna id de users_teams
}))


  // 2️⃣ Carregar activitats_jugadors del dia
  const { data: actData, error: actError } = await supabaseClient
    .from('registres_entrenaments')
    .select('*')
    .in('user_team_id', jugadors.map(j => j.user_team_id))
    .eq('data_sessio', avui)

  if (actError) {
    console.error(actError)
    return
  }

  renderJugadors([])   // primer pinta jugadors buits
await carregarRegistresDelDia(avui)   // després omple si hi ha dades
renderCalendariSetmanal(equipId)

  renderCalendariSetmanal(equipId)

}


function renderJugadors(actData=[]) {
  jugadorsList.innerHTML = ''
  jugadors.forEach(j => {
    const aj = actData.find(a => a.user_team_id === j.user_team_id) || {}

    const div = document.createElement('div')
    div.className='jugador'
      div.innerHTML = `
  <span>${j.nom} ${j.cognom}</span>
  <input type="number" placeholder="PF" data-jtid="${j.user_team_id}" class="temps-pf" value="${aj.temps_pf??0}">
  <input type="number" placeholder="Pista" data-jtid="${j.user_team_id}" class="temps-pista" value="${aj.temps_pista??0}">
  <input type="checkbox" data-jtid="${j.user_team_id}" class="partit-jug" ${aj.partit?'checked':''}>
    `
    jugadorsList.appendChild(div)
  })
}

// ----------------
// BOTÓ D’APLICAR A TOTS
// ----------------
const aplicarBtn = document.getElementById('aplicar-a-tots')
aplicarBtn.addEventListener('click', () => {
  const pfVal = pfInput.value || 0
  const pistaVal = pistaInput.value || 0
  const partitVal = partitCheck.checked

  document.querySelectorAll('.temps-pf').forEach(i => i.value = pfVal)
  document.querySelectorAll('.temps-pista').forEach(i => i.value = pistaVal)
  document.querySelectorAll('.partit-jug').forEach(i => i.checked = partitVal)
})

// ----------------
// BOTÓ GUARDAR TOTS
// ----------------
const guardarTotsBtn = document.getElementById('guardar-tots') 
guardarTotsBtn.addEventListener('click', async () => { 
	const novaData = dataInput.value

	for (const j of jugadors) { 
const pf = document.querySelector(`.temps-pf[data-jtid="${j.user_team_id}"]`).value || 0
const pista = document.querySelector(`.temps-pista[data-jtid="${j.user_team_id}"]`).value || 0
const partit = document.querySelector(`.partit-jug[data-jtid="${j.user_team_id}"]`).checked

		// Assegurar que dataSeleccionada cobreix tot el dia
const dia = new Date(dataSeleccionada);
const start = new Date(dia);
start.setHours(0, 0, 0, 0); // inici del dia
const end = new Date(dia);
end.setHours(23, 59, 59, 999); // final del dia

const { data: exist, error } = await supabaseClient
  .from('registres_entrenaments')
  .select('*')
  .eq('user_team_id', j.user_team_id)
  .gte('data_sessio', start.toISOString())
  .lte('data_sessio', end.toISOString())
  .limit(1)
  .single();
 
if (exist) { 
await supabaseClient 
.from('registres_entrenaments') 
.update({ data_sessio: novaData, temps_pf: pf, temps_pista: pista, partit: partit }) 
.eq('id', exist.id) 
} else { 
await supabaseClient 
.from('registres_entrenaments') 
.insert({ user_team_id: j.user_team_id, data_sessio: novaData, temps_pf: pf, temps_pista: pista, partit: partit }) 
} 
} 
msg.textContent = "Dades guardades!" 
setTimeout(()=>msg.textContent='',2000) 
renderCalendariSetmanal(equipActual)
})


async function renderCalendariSetmanal(equipId) {

	if (!equipId) return;

  const avui = new Date();
  const year = anyActual
	const month = mesActual

  const primerDia = new Date(year, month, 1);
  const ultimDia = new Date(year, month + 1, 0);
  const numDies = ultimDia.getDate();
const mesos = [
  'Gener','Febrer','Març','Abril','Maig','Juny',
  'Juliol','Agost','Setembre','Octubre','Novembre','Desembre'
]

document.getElementById('titol-mes').textContent =
  mesos[month] + ' ' + year


  // Obtenir registres del mes per aquell equip
  const { data: registres } = await supabaseClient
    .from('registres_entrenaments')
    .select('data_sessio,user_team_id')
    .in('user_team_id', jugadors.map(j => j.user_team_id))
    .gte('data_sessio', `${year}-${String(month+1).padStart(2,'0')}-01`)
    .lte('data_sessio', `${year}-${String(month+1).padStart(2,'0')}-${numDies}`);

  // Map de dies amb sessions
  const diesAmbSessio = new Set(registres.map(r => r.data_sessio));

  const calHeader = document.getElementById('cal-header');
  const calBody = document.getElementById('cal-body');

  // Header: dies de la setmana
  const diesSetmana = ['DL', 'DM', 'DC', 'DJ', 'DV', 'DS', 'DG'];
  calHeader.innerHTML = '';
  diesSetmana.forEach(d => {
    const th = document.createElement('th');
    th.textContent = d;
    calHeader.appendChild(th);
  });

  // Cos del calendari
  calBody.innerHTML = '';
  let tr = document.createElement('tr');
  let diaSetmana = primerDia.getDay() === 0 ? 6 : primerDia.getDay() - 1; // Ajustar Dilluns=0

  // Cel·les buides abans del primer dia
  for (let i = 0; i < diaSetmana; i++) {
    const td = document.createElement('td');
    td.textContent = '';
    tr.appendChild(td);
  }

  for (let dia = 1; dia <= numDies; dia++) {
    const td = document.createElement('td');
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;

    td.textContent = dia;
    td.style.cursor = 'pointer';
    td.style.padding = '10px';
    td.style.textAlign = 'center';
    td.style.border = '1px solid #ccc';

    if (diesAmbSessio.has(dateStr)) {
  td.style.backgroundColor = '#a0e7a0'
  td.draggable = true
}


    td.addEventListener('click', async () => {
  dataSeleccionada = dateStr
  dataInput.value = dateStr
  await carregarRegistresDelDia(dateStr)
})

td.addEventListener('dragstart', (e) => {
  dataArrossegada = dateStr
})

td.addEventListener('dragover', (e) => {
  e.preventDefault()
})

td.addEventListener('drop', async () => {
  if (!dataArrossegada) return
  if (dataArrossegada === dateStr) return

  if (!confirm(`Moure la sessió del ${dataArrossegada} al ${dateStr}?`)) return

  await moureSessio(dataArrossegada, dateStr)

  dataArrossegada = null
  renderCalendariSetmanal(equipActual)
})




    tr.appendChild(td);
    diaSetmana++;
    if (diaSetmana === 7) {
      calBody.appendChild(tr);
      tr = document.createElement('tr');
      diaSetmana = 0;
    }
  }

  // Cel·les buides després de l’últim dia
  if (diaSetmana !== 0) {
    for (let i = diaSetmana; i < 7; i++) {
      const td = document.createElement('td');
      td.textContent = '';
      tr.appendChild(td);
    }
    calBody.appendChild(tr);
  }
}

async function carregarRegistresDelDia(dataSeleccionada) {
  if (!jugadors.length) return

  const { data: registres, error } = await supabaseClient
    .from('registres_entrenaments')
    .select('*')
    .in('user_team_id', jugadors.map(j => j.user_team_id))
    .eq('data_sessio', dataSeleccionada)

  if (error) {
    console.error(error)
    return
  }

  jugadors.forEach(j => {
    const reg = registres.find(r => r.user_team_id === j.user_team_id)

    const pfInput = document.querySelector(`.temps-pf[data-jtid="${j.user_team_id}"]`)
    const pistaInput = document.querySelector(`.temps-pista[data-jtid="${j.user_team_id}"]`)
    const partitInput = document.querySelector(`.partit-jug[data-jtid="${j.user_team_id}"]`)

    if (reg) {
      pfInput.value = reg.temps_pf ?? 0
      pistaInput.value = reg.temps_pista ?? 0
      partitInput.checked = reg.partit ?? false
    } else {
      pfInput.value = 0
      pistaInput.value = 0
      partitInput.checked = false
    }
  })
}

document.getElementById('prev-mes').addEventListener('click', () => {
  mesActual--
  if (mesActual < 0) {
    mesActual = 11
    anyActual--
  }
  renderCalendariSetmanal(equipActual)
})

document.getElementById('next-mes').addEventListener('click', () => {
  mesActual++
  if (mesActual > 11) {
    mesActual = 0
    anyActual++
  }
  renderCalendariSetmanal(equipActual)
})


async function moureSessio(dataOrigen, dataDesti) {

  const { error } = await supabaseClient
    .from('registres_entrenaments')
    .update({ data_sessio: dataDesti })
    .in('user_team_id', jugadors.map(j => j.user_team_id))
    .eq('data_sessio', dataOrigen)

  if (error) {
    console.error(error)
    alert("Error movent sessió")
    return
  }

  alert("Sessió moguda correctament")
}



init()
</script>
</body>
</html>
