<!DOCTYPE html>
<html lang="ca">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPE Multijugador</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    input {
      font-size: 1.2rem;
      padding: 5px;
    }
    button {
      font-size: 2.5rem;
      margin: 10px;
      width: 80px;
      height: 80px;
    }
  </style>
</head>
<body>

<h1>RPE</h1>
<p id="pregunta">Com et sents avui?</p>

<div id="login">
  <input type="text" id="nomJugador" placeholder="Introdueix el teu nom" />
  <button id="btnNom">Comen√ßa</button>
</div>

<div id="botons" style="display:none;"></div>
<p id="msg"></p>

<script>
  // ====================
  // Configuraci√≥ Supabase
  // ====================
  const SUPABASE_URL = 'https://yixicmvonuiqdgcaiogb.supabase.co'
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpeGljbXZvbnVpcWRnY2Fpb2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTU5MDksImV4cCI6MjA4NTU5MTkwOX0.NYiQN75-BqfiVkNRkwRsU6PE0fFleuPG6o5BaklhWgs'
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

  console.log('Supabase object:', supabase)
  console.log('Supabase client:', supabaseClient)


  // ====================
  // Elements HTML
  // ====================
  const nomInput = document.getElementById('nomJugador')
  const btnNom = document.getElementById('btnNom')
  const botonsDiv = document.getElementById('botons')
  const msg = document.getElementById('msg')
  const loginDiv = document.getElementById('login')

  let jugadorId = localStorage.getItem('jugadorId')

  // ====================
  // Si ja tenim jugador guardat
  // ====================
  if (jugadorId) {
    const carregarJugador = async () => {
      const { data, error } = await supabaseClient
        .from('users')
        .select('nom')
        .eq('id', jugadorId)
        .single()

      if (!error && data) {
        actualitzarPregunta(data.nom)
        loginDiv.style.display = 'none'
        botonsDiv.style.display = 'block'
        mostrarBotons()
      } else {
        // si hi ha algun problema, tornem al login
    	localStorage.removeItem('jugadorId')
      }
    }

    carregarJugador()
  }


  const pregunta = document.getElementById('pregunta')

  function actualitzarPregunta(nom) {
    const nomBonic = nom.charAt(0).toUpperCase() + nom.slice(1)
    pregunta.textContent = `${nomBonic}, com et sents avui?`
  }


  // ====================
  // Funci√≥ per mostrar botons
  // ====================
  function mostrarBotons() {
    for (let i = 1; i <= 10; i++) {
      const b = document.createElement('button')
      b.textContent = i
      b.onclick = async () => {
        msg.textContent = 'Enviant RPE ' + i + '...'
        const { error } = await supabaseClient.from('rpe_registres')
  					.upsert({jugador_id: jugadorId,
    						valor: i,
						data: avui
  					})
        if (error) {
          console.error(error)
          msg.textContent = 'Error üòï'
        } else {
          msg.textContent = 'Gr√†cies!'
          setTimeout(() => msg.textContent = '', 2000)
        }
      }
      botonsDiv.appendChild(b)
    }
  }

  // ====================
  // Bot√≥ per entrar nom
  // ====================
  btnNom.onclick = async () => {
  let codi = nomInput.value.trim().toLowerCase()
  if (!codi) return alert("Escriu el teu codi!")

  // -------------------
  // Buscar l'usuari pel codi
  // -------------------
  const { data: user, error } = await supabaseClient
    .from('users')
    .select('*')
    .eq('codi', codi)
    .limit(1)
    .single() // retornem nom√©s un registre

  if (error) {
    console.error(error)
    return alert("Error a la base de dades")
  }

  if (!user) {
    return alert("Codi no v√†lid. Contacta amb l'administrador.")
  }

  jugadorId = user.id

  // -------------------
  // Si no t√© email, demanar-lo
  // -------------------
  if (!user.email) {
    let email = prompt("Si us plau, introdueix el teu email:")
    if (!email) return alert("Has d‚Äôintroduir l‚Äôemail!")
    const { error: errEmail } = await supabaseClient
      .from('users')
      .update({ email })
      .eq('id', jugadorId)
    if (errEmail) return alert("Error guardant email")
  }

  // -------------------
  // Guardar a localStorage
  // -------------------
  localStorage.setItem('jugadorId', jugadorId)

  // -------------------
  // Amagar login i mostrar botons
  // -------------------
  loginDiv.style.display = 'none'
  botonsDiv.style.display = 'block'

  // Mostrar pregunta amb nom si existeix
  actualitzarPregunta(user.nom || codi)

  mostrarBotons()
}


</script>

</body>
</html>