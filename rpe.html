<!DOCTYPE html>
<html lang="ca">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPE Multijugador</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    input {
      font-size: 1.2rem;
      padding: 5px;
    }
    button {
      font-size: 2.5rem;
      margin: 10px;
      width: 80px;
      height: 80px;
    }

#calendari-setmana {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .dia-setmana {
      text-align: center;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .dia-box {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #eee;
      font-weight: bold;
    }

    .dia-box.pendent {
      background-color: #ff4d4d;
      color: white;
    }

    #calendari {
      overflow-x:auto; 
      margin-top:20px;
    }

    #cal-table {
      border-collapse: collapse; 
      width: 100%;
    }

    #cal-table th, #cal-table td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    .clicable {
      background-color: #ff4d4d;
      color: white;
      cursor: pointer;
    }

    .no-clicable {
      background-color: #eee;
      color: #888;
      cursor: not-allowed;
    }


  </style>
</head>
<body>

<h1>RPE</h1>
<p id="pregunta">Com et sents avui?</p>

<div id="login">
  <input type="text" id="nomJugador" placeholder="Introdueix el teu nom" />
  <button id="btnNom">Comen√ßa</button>
</div>



<div id="calendari" style="overflow-x:auto; margin-top:20px;">
  <table id="cal-table" border="1" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr id="cal-header"></tr>
    </thead>
    <tbody id="cal-body"></tbody>
  </table>
</div>



<div id="botons" style="display:none;"></div>
<p id="msg"></p>

<script>
  // ====================
  // Configuraci√≥ Supabase
  // ====================
  const SUPABASE_URL = 'https://yixicmvonuiqdgcaiogb.supabase.co'
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpeGljbXZvbnVpcWRnY2Fpb2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTU5MDksImV4cCI6MjA4NTU5MTkwOX0.NYiQN75-BqfiVkNRkwRsU6PE0fFleuPG6o5BaklhWgs'
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

  console.log('Supabase object:', supabase)
  console.log('Supabase client:', supabaseClient)


  // ====================
  // Elements HTML
  // ====================
  const nomInput = document.getElementById('nomJugador')
  const btnNom = document.getElementById('btnNom')
  const botonsDiv = document.getElementById('botons')
  const msg = document.getElementById('msg')
  const loginDiv = document.getElementById('login')

  let jugadorId = localStorage.getItem('jugadorId')

  // ====================
  // Si ja tenim jugador guardat
  // ====================
  if (jugadorId) {
    const carregarJugador = async () => {
      const { data, error } = await supabaseClient
        .from('users')
        .select('nom')
        .eq('id', jugadorId)
        .single()

      if (!error && data) {
        actualitzarPregunta(data.nom)
        loginDiv.style.display = 'none'
        botonsDiv.style.display = 'block'
        mostrarBotons()
        renderCalendariSetmana()
      } else {
        // si hi ha algun problema, tornem al login
    	localStorage.removeItem('jugadorId')
      }
    }

    carregarJugador()
  }

  const calendariDiv = document.getElementById('calendari')

  const pregunta = document.getElementById('pregunta')

  function actualitzarPregunta(nom) {
    const nomBonic = nom.charAt(0).toUpperCase() + nom.slice(1)
    pregunta.textContent = `${nomBonic}, com et sents avui?`
  }


  // ====================
  // Funci√≥ per mostrar botons
  // ====================
  function mostrarBotons() {
    for (let i = 1; i <= 10; i++) {
      const b = document.createElement('button')
      b.textContent = i
      b.onclick = async () => {
        msg.textContent = 'Enviant RPE ' + i + '...';
        const avui = new Date().toISOString();  // data i hora actual
        const { error } = await supabaseClient
          .from('rpe_registres')
          .upsert({jugador_id: jugadorId, valor: i, data: avui, data_sessio: dataSeleccionada});

        if (error) {
          console.error(error);
          msg.textContent = 'Error üòï';
        } else {
          msg.textContent = 'Gr√†cies!';
          // Espera 1 segon abans de fer l'acci√≥ segons rol
          setTimeout(async () => {
            const pendents = await hiHaPendents();
            if (pendents) {
              if (rolUsuari === 'USER') {
                const resposta = confirm("Tens entrenaments sense RPE.\n\nVols tancar l'app?\nPrem CANCEL¬∑LAR per registrar l'RPE que falta.");

                if (resposta) {
                  window.close(); // nom√©s funciona si s'ha obert amb JS
                }
              } else if (rolUsuari === 'ADMIN' || rolUsuari === 'SUPERADMIN') {
                const resposta = confirm("Hi ha entrenaments sense RPE.\n\nVols tornar a la pantalla inicial?\nPrem CANCEL¬∑LAR per registrar l'RPE.");

                if (resposta) {
                  window.location.href = 'index.html';
                }
              }
            } else {
              // NO HI HA PENDENTS
              if (rolUsuari === 'USER') {
                msg.textContent = "Gr√†cies! L'aplicaci√≥ es tancar√†.";
                setTimeout(() => {window.close();}, 1500);
              } else {
                msg.textContent = "Gr√†cies! Tornant a la pantalla principal.";
                setTimeout(() => {window.location.href = 'index.html';}, 1500);
              }
            }
          } 1000);
        }
      };

      botonsDiv.appendChild(b)
    }
  }

  // ====================
  // Bot√≥ per entrar nom
  // ====================
  btnNom.onclick = async () => {
  let codi = nomInput.value.trim().toLowerCase()
  if (!codi) return alert("Escriu el teu codi!")

  // -------------------
  // Buscar l'usuari pel codi
  // -------------------
  const { data: user, error } = await supabaseClient
    .from('users')
    .select('*')
    .eq('codi', codi)
    .limit(1)
    .single() // retornem nom√©s un registre

  if (error) {
    console.error(error)
    return alert("Error a la base de dades")
  }

  if (!user) {
    return alert("Codi no v√†lid. Contacta amb l'administrador.")
  }

  jugadorId = user.id

  // -------------------
  // Si no t√© email, demanar-lo
  // -------------------
  if (!user.email) {
    let email = prompt("Si us plau, introdueix el teu email:")
    if (!email) return alert("Has d‚Äôintroduir l‚Äôemail!")
    const { error: errEmail } = await supabaseClient
      .from('users')
      .update({ email })
      .eq('id', jugadorId)

    if (errEmail) return alert("Error guardant email")
  }

  // -------------------
  // Guardar a localStorage
  // -------------------
  localStorage.setItem('jugadorId', jugadorId)

  // -------------------
  // Amagar login i mostrar botons
  // -------------------
  loginDiv.style.display = 'none'
  botonsDiv.style.display = 'block'

  // Mostrar pregunta amb nom si existeix
  actualitzarPregunta(user.nom || codi)

  mostrarBotons()
  renderCalendariSetmana()

}


async function renderCalendariSetmana() {
  const avui = new Date();
  const year = 2025
  const month = 2

  const primerDia = new Date(year, month, 1);
  const ultimDia = new Date(year, month + 1, 0);
  const numDies = ultimDia.getDate();

  const calHeader = document.getElementById('cal-header');
  const calBody = document.getElementById('cal-body');

  const diesSetmana = diesSetmanaRotats();

  calHeader.innerHTML = '';
  diesSetmana.forEach(d => {
    const th = document.createElement('th');
    th.textContent = d;
    calHeader.appendChild(th);
  });

  // Cos del calendari: √∫ltims 7 dies fins avui
  calBody.innerHTML = '';
  let tr = document.createElement('tr');

  // √öltims 7 dies: del m√©s antic al m√©s recent (avui incl√≤s)
  const dies = [];
  for (let i = 6; i >= 0; i--) {
    const dia = new Date(avui);
    dia.setDate(avui.getDate() - i); // restem dies correctament
    dies.push(dia);
  }

  // Inicialitzar tots els botons RPE com desactivats
  Array.from(botonsDiv.children).forEach(boto => {
    boto.style.cursor = 'not-allowed';
    boto.style.pointerEvents = 'none';
    boto.style.opacity = '0.6';
    boto.style.outline = 'none';
  });

  const { data: sessions, error } = await supabaseClient
    .from('registres_entrenaments')
    .select('data_sessio')  // nom√©s la data, sense la relaci√≥
    .in('user_team_id',       // columna FK
         await supabaseClient
          .from('users_teams')  // la taula dels equips/relacions
          .select('id')
          .eq('user_id', jugadorId)
          .then(r => r.data.map(row => row.id))
    )
    .gte('data_sessio', dies[0].toISOString().split('T')[0])
    .lte('data_sessio', dies[6].toISOString().split('T')[0]);

 const diesAmbSessio = new Set((sessions || []).map(d => {
    const dt = new Date(d.data_sessio)
    const any = dt.getFullYear()
    const mes = String(dt.getMonth() + 1).padStart(2, '0')
    const dia = String(dt.getDate()).padStart(2, '0')
    return `${any}-${mes}-${dia}`
  }))

  // ====================
  // Afegir RPE ja registrat
  // ====================
  // Agafem RPE per aquest jugador i la setmana
  const { data: rpes } = await supabaseClient
    .from('rpe_registres')
    .select('data_sessio, valor')
    .eq('jugador_id', jugadorId)
    .in('data_sessio',
        dies.map(d => {
          const any = d.getFullYear()
          const mes = String(d.getMonth() + 1).padStart(2, '0')
          const dia = String(d.getDate()).padStart(2, '0')
          return `${any}-${mes}-${dia}`
        })
    )

  // Map per accedir r√†pidament: dateISO ‚Üí valor
  const rpeMap = new Map();
  rpes?.forEach(r => {
    const dt = new Date(r.data_sessio)
    const any = dt.getFullYear()
    const mes = String(dt.getMonth() + 1).padStart(2, '0')
    const dia = String(dt.getDate()).padStart(2, '0')
    const dateISO = `${any}-${mes}-${dia}`
    rpeMap.set(dateISO, r.valor)
  })

  // Crear cel¬∑les per cada dia
  dies.forEach(dia => {
    const td = document.createElement('td')
    const diaStr = String(dia.getDate()).padStart(2,'0')
    const mesStr = String(dia.getMonth()+1).padStart(2,'0')
    const dateISO = `${dia.getFullYear()}-${mesStr}-${diaStr}`
    td.textContent = `${diaStr}/${mesStr}`

    // --------------------
    // Si ja hi ha RPE ‚Üí verd i no clicable. Si no, vermell i clicable
    // --------------------
    if (rpeMap.has(dateISO)) {
      td.style.backgroundColor = '#4caf50' // verd
      td.style.color = 'white'
      td.style.cursor = 'not-allowed'
    } else if (diesAmbSessio.has(dateISO)) {
      // Dia amb sessi√≥ ‚Üí vermell, clicable
      td.classList.add('clicable');
      td.addEventListener('click', () => {
        dataSeleccionada = dateISO;
        // Marcar dia seleccionat
        document.querySelectorAll('.seleccionat').forEach(d => d.classList.remove('seleccionat'));
        td.classList.add('seleccionat');
        // Activar tots els botons RPE
        Array.from(botonsDiv.children).forEach(boto => {
          boto.style.cursor = 'pointer';
          boto.style.pointerEvents = 'auto';
          boto.style.opacity = '1';
          boto.style.outline = 'none';
        });
      });
    } else {
      td.classList.add('no-clicable')
    }
    tr.appendChild(td)
  })

  // Afegir la fila al tbody
  calBody.appendChild(tr);
}


// Cridar despr√©s de carregar jugadors o al iniciar
function diesSetmanaRotats() {
  // Header: dies de la setmana
  const diesSetmanaNom = ['DL','DM','DC','DJ','DV','DS','DG']

  const avui = new Date()
  const avuiIndex = avui.getDay() === 0 ? 6 : avui.getDay() - 1 // Dilluns=0

  const rotat = []

  // 7 dies: dem√† fins avui
  for (let i = 1; i <= 7; i++) {
    const index = (avuiIndex + i) % 7
    rotat.push(diesSetmanaNom[index])
  }

  return rotat
}

async function hiHaPendents() {
  const avui = new Date();

  const dies = [];
  for (let i = 6; i >= 0; i--) {
    const dia = new Date(avui);
    dia.setDate(avui.getDate() - i);
    dies.push(dia);
  }

  const diesISO = dies.map(d => {
    const any = d.getFullYear()
    const mes = String(d.getMonth() + 1).padStart(2, '0')
    const dia = String(d.getDate()).padStart(2, '0')
    return `${any}-${mes}-${dia}`
  });

  // sessions
  const { data: sessions } = await supabaseClient
    .from('registres_entrenaments')
    .select('data_sessio')
    .in('user_team_id',
         await supabaseClient
          .from('users_teams')
          .select('id')
          .eq('user_id', jugadorId)
          .then(r => r.data.map(row => row.id))
    )
    .in('data_sessio', diesISO);

  const diesAmbSessio = new Set((sessions || []).map(s => s.data_sessio));

  // rpes
  const { data: rpes } = await supabaseClient
    .from('rpe_registres')
    .select('data_sessio')
    .eq('jugador_id', jugadorId)
    .in('data_sessio', diesISO);

  const diesAmbRPE = new Set((rpes || []).map(r => r.data_sessio));

  // Comprovem si algun dia amb sessi√≥ NO t√© RPE
  for (let dia of diesAmbSessio) {
    if (!diesAmbRPE.has(dia)) {
      return true;
    }
  }

  return false;
}

</script>
</body>
</html>